



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Followup do treinamento de novos modelos para o AJNA com TensorFlow2.0">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Conclusões - Projeto AJNA - Treinamento de modelos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#conclusoes" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Projeto AJNA - Treinamento de modelos" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Projeto AJNA - Treinamento de modelos
            </span>
            <span class="md-header-nav__topic">
              
                Conclusões
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Projeto AJNA - Treinamento de modelos" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Projeto AJNA - Treinamento de modelos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Definição" class="md-nav__link">
      Definição
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../resumo/" title="Análise" class="md-nav__link">
      Análise
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../notebooks/" title="Relatório ChestXRay" class="md-nav__link">
      Relatório ChestXRay
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../notebooks_vazios/" title="Relatório Vazios" class="md-nav__link">
      Relatório Vazios
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Conclusões
      </label>
    
    <a href="./" title="Conclusões" class="md-nav__link md-nav__link--active">
      Conclusões
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#observacoes" title="Observações" class="md-nav__link">
    Observações
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-chestxray" title="Base ChestXRay" class="md-nav__link">
    Base ChestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-vazios" title="Base Vazios" class="md-nav__link">
    Base Vazios
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#desempenho-em-tempo-e-consumo-de-memoria" title="Desempenho (em tempo e consumo de memória)" class="md-nav__link">
    Desempenho (em tempo e consumo de memória)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sobre/" title="Sobre" class="md-nav__link">
      Sobre
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../extratores/" title="Extratores" class="md-nav__link">
      Extratores
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#observacoes" title="Observações" class="md-nav__link">
    Observações
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-chestxray" title="Base ChestXRay" class="md-nav__link">
    Base ChestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-vazios" title="Base Vazios" class="md-nav__link">
    Base Vazios
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#desempenho-em-tempo-e-consumo-de-memoria" title="Desempenho (em tempo e consumo de memória)" class="md-nav__link">
    Desempenho (em tempo e consumo de memória)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="conclusoes">Conclusões</h1>
<h2 id="observacoes">Observações</h2>
<p>Foram utilizadas várias técnicas e realizadas diversas iterações/melhorias dentro das técnicas, sucessivamente.</p>
<p>Além disso, paralelamente, testes parecidos foram realizados em bases diferentes para testar generalidade do modelo.</p>
<h2 id="base-chestxray">Base ChestXRay</h2>
<p>Conforme era esperado, esta base se mostrou mais difícil de trabalhar do que a base de escaneamento de 
contêineres para classificar vazio/ não vazio</p>
<p>Considerou-se que para este tipo de problema o mais importante é um recall alto para pneumonia.</p>
<p>O modelo final tem um recall excelente, embora o desejável neste caso seja 100%, não sabemos se há
erro de rotulagem nem qual o erro humano, muito menos o Bayes Error. Portanto, não dá para saber se 
é factível melhorar acima de 95-97% de recall. </p>
<p>Não foi possível obter ganhos significativos em relação ao baseline com as técnicas empregadas. 
A melhoria foi marginal, de menos de 5% em relação à rede neural simples. Tabela abaixo.</p>
<p>REDE 01b
Accuracy:           acc 0.95 val_acc 0.85
recall pneumonia:       0.94         0.95
REDE 02e
Accuracy:           acc 0.95 val_acc 0.89
recall pneumonia:       0.96         0.97</p>
<p>A diferença entre treinamento e validação demonstra uma variância grande, mas pelos testes na base seria importante checar
se não se trata de um  <em>data mismatch</em>. </p>
<p>Esta base parece ter problemas de balanceamento e também de distribuição. Como
próximo passo, seria interessante fundir todos os exemplos da base orginal (train, val, test) em uma base única e fazer um
<em>resample</em> das bases de treinamento e validação, rodando cópias destes notebooks e comparando os resultados. Além disso,
testar técnicas adicionais de <em>image augmentation</em> e balanceamento de classes (parâmetro <em>class weight</em> ou aumento de uma
categoria).</p>
<h2 id="base-vazios">Base Vazios</h2>
<p>Nesta base também considerou-se que o mais importante seria obter um recall alto, reconhecendo principalmente
contêineres declarados como vazios mas contendo carga. </p>
<p>Os resultados da rede simples treinada do zero foram similares ao uso de rede DenseNet, 
mas a extração de features com rede pré treinada na imagenet pode ser um método universal
 base para vários classificadores, buscas e análises.</p>
<p>Assim, quando uma imagem entrar no Banco de Dados, pré extrair as features via uma rede pré treinada,
 salvando no Banco de Dados, pode servir como ponto de entrada para vários tipos de classificadores e 
 comparações, salvando memória e processamento posterior.</p>
<p>Os resultados utilizando maxpool e avgpool como extrator de características foram muito similares, com
leve vantagem para avgpool nos resultados e menor tempo de convergência. </p>
<p>Os melhores resultados obtidos foram de 96% de accuracy e 96% de f1-score, sendo que a base parece ter 
em torno de 2% de erros de rotulagem. Com a base limpa, o resultado subiu a quase 98%.
Embora pela visualização haja espaço para melhora (alguns contêineres não vazios com muito pouca carga
mas facilmente identifiáveis pelo olho humano classificados como vazios), o modelo está muito próximo de um
candidato a colocação em produção. Outro ponto interessante é que foi demostrado ser possível utilizar
um classificador extremamente simples e rápido, que utiliza como ponto de entrada apenas 1024 números que
podem ser pré-extraídos das imagens pela rede DenseNet121 e ocupa apenas 14MB de RAM por batch. </p>
<p>Neste problema, a rede Siamesa treinada também apresentou resultados excelentes. Utilizar redes siamesas para 
classificação adiciona uma complexidade: como a rede sempre compara duas imagens, não há uma rede treinada para
simplesmente fazer a classificação da imagem, mas sim dar um número (próximo de zero para itens iguais ou 
da mesma classe, próximo de 1 para itens diferentes). Optou-se por comparar a imagem a ser classificada com
duas imagens: uma da classe 0 e outra da classe1. A que retornar menor número é considerada a correta.</p>
<p>Baseline SVM</p>
<pre><code>         precision    recall  f1-score   support

      0     1.0000    0.9117    0.9538      1166
      1     0.9179    1.0000    0.9572      1151
</code></pre>
<p>Rede 01b3 (baseline simples)</p>
<pre><code>         precision    recall  f1-score   support

      0     1.0000    0.9245    0.9608      1166
      1     0.9290    1.0000    0.9632      1151
</code></pre>
<p>Rede 02c3 (<em>Features</em> da DenseNet121 treinada na Imagenet)</p>
<pre><code>         precision    recall  f1-score   support

      0     0.9900    0.9297    0.9589      1166
      1     0.9329    0.9904    0.9608      1151
</code></pre>
<p>Rede Siamesa </p>
<pre><code>       precision    recall  f1-score   support

    0.0     0.9972    0.9228    0.9586      1166
    1.0     0.9273    0.9974    0.9611      1151
</code></pre>
<p><img alt="Grafico comparativo" src="../images/comparacao.png" /></p>
<p>Mais do que apenas ver os números, seria interessante visualizar e entender os erros que
cada modelo está cometendo. Assim, no notebook 05 comparei também os erros de cada modelo 
entre si. A divergência maior foi entre o modelo 1 e os demais, chegando a 3%. Os modelos de
redes neurais possuem menos de 1,5% de divergência entre os erros e acertos. Isso indica comprovação
parcial da teoria de que: 1. Há erros de rótulo, 2. Há exemplos muito difíceis ou no limiar.</p>
<p>Para lembrar, no início do treinamento o modelo cometia erros como os abaixo, classificando contêineres
claramente não vazios como vazios, mas com probabilidade baixa (65% ou menos, sendo que 50% é o limiar para
classificação na outra classe).</p>
<p><img alt="Erros bobos" src="../images/erros_vaziospoucacarga.png" /></p>
<p>Já os últimos modelos estão cometendo os erros mostrados abaixo. Note-se que o SVM comete erros "bobos". Já os erros de rede
neural, especialmente os com recall mais alto, quase em 100% das vezes fica difícil de saber se é erro de rótulo, pois a visualização
também indica um contêiner sem carga.</p>
<ul>
<li>
<p>Erros SVM
<img alt="Erros 1" src="../images/erros_1.png" /></p>
</li>
<li>
<p>Erros Rede Neural Simples
<img alt="Erros 2" src="../images/erros_2.png" /></p>
</li>
<li>
<p>Erros DenseNet Transfer Learning
<img alt="Erros 3" src="../images/erros_3.png" /></p>
</li>
<li>
<p>Erros DenseNet Transfer Learning com class weights
<a href="../images/erros_3a.png">Erros 3a</a></p>
</li>
<li>
<p>Erros Siamesa
<img alt="Erros 4" src="../images/erros_4.png" /></p>
</li>
</ul>
<h3 id="desempenho-em-tempo-e-consumo-de-memoria">Desempenho (em tempo e consumo de memória)</h3>
<p>Devido à grande dimensionalidade do problema, a solução SVM ocupa bastante memória e é a que tem maior tempo de 
execução (em computador que possui GPU, provavelmente sem GPUs as redes neurais teriam desempenho muito inferior)
 Em seguida a rede DenseNet pré treinada é a que tem maior uso de memória. A rede neural simples possui o menor uso de
 memória de todas e maior rapidez. A rede siamesa utiliza memória intermediária mas se mostrou mais lenta que a rede imagenet,
 pois precisa extrair features de duas imagens para depois fazer comparações.</p>
<p>Tempos para carregar do disco, redimensionar e fazer predicões em 2317 imagens:</p>
<pre><code>Nome da técnica             tempo           Consumo de memória          GPU(1) 
Rede DenseNet121            2min 35s            Alto                    Não
SVM                         1min 37s            Alto                    Não
Rede DenseNet121            25.2 s              Alto                    Sim
Rede neural simples 01b3    22.2 s              Alto                    Não
Rede siamesa(2)             15.4 s              Médio                   Sim
Rede neural simples 01b3    9.15 s              Médio-baixo             Sim
Tratar 1024 features(3)      43 ms              Baixo                   Não
Tratar 1024 features(3)      126 ms             Baixo                   Sim
Tratar 128 features(3)      &lt;10 ms              Muito baixo             Sim
</code></pre>
<ol>
<li>
<p>GPU não é estritamente necessária para predição de redes neurais, mas em uma predição de rede neural,
 especialmente uma rede convolucional, o tempo é muito maior sem utilização de GPU. Para este teste foi utilizada
 CPU Intel i5 com 2.30ghz e 8 cores, cache L1 32K, L1 256K e L3 8192K e NUMA mode. A GPU utilizada foi uma GTX1050ti 4GB,
 cuda 10.1. Memória do Sistema de 8GB. </p>
</li>
<li>
<p>A rede siamesa precisa sempre passar duas imagens, por isso o tempo é maior que 01b3. Para melhorar a precisão,
poderiam ser comparadas vários pares de imagens, e os tempos serão somados</p>
</li>
<li>
<p>Desde o começo do projeto uma das idéias que saem do padrão de simplesmente treinar um classificador do iníco ao 
fim é reutilizar os aprendizados de uma etapa em outra. Assim, caso as imagens estejam em uma base centralizada,
uma boa prática que quase nunca é vista nos <em>papers</em> ou tutoriais seria fazer pré extração de <em>features</em> em batch e utilizar,
posteriormente, estas <em>features</em> ao invés de carregar a imagem original. É uma redução entre 2.400 a 20.000 vezes (de 
uma imagem SVGA para 1.024 ou 128 floats por exemplo). Assim, economiza-se disco, I/O, processamento, memória, 
energia elétrica e a redução drástica do tempo de processamento possibilita inclusive fazer tarefas 
muito mais complexas, como uma busca de similaridade em todo o banco de dados ou agrupamento
(clusterização) das imagens.</p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../notebooks_vazios/" title="Relatório Vazios" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Relatório Vazios
              </span>
            </div>
          </a>
        
        
          <a href="../sobre/" title="Sobre" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Sobre
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>