



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Followup do treinamento de novos modelos para o AJNA com TensorFlow2.0">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Relatório ChestXRay - Projeto AJNA - Treinamento de modelos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#relatorios-da-base-chestxray" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Projeto AJNA - Treinamento de modelos" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Projeto AJNA - Treinamento de modelos
            </span>
            <span class="md-header-nav__topic">
              
                Relatório ChestXRay
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Projeto AJNA - Treinamento de modelos" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Projeto AJNA - Treinamento de modelos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Definição" class="md-nav__link">
      Definição
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../resumo/" title="Análise" class="md-nav__link">
      Análise
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Relatório ChestXRay
      </label>
    
    <a href="./" title="Relatório ChestXRay" class="md-nav__link md-nav__link--active">
      Relatório ChestXRay
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#01-baseline-redesimples-chestxray" title="01-Baseline-redesimples-chestXRay" class="md-nav__link">
    01-Baseline-redesimples-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01b-baseline-redesimples-chestxray-tamanhomaior" title="01b-Baseline-redesimples-chestXRay-tamanhomaior" class="md-nav__link">
    01b-Baseline-redesimples-chestXRay-tamanhomaior
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02c-transferlearningsimples-featureextractionregularizer-chestxray" title="02c-TransferLearningSimples-FeatureExtractionRegularizer-chestXRay" class="md-nav__link">
    02c-TransferLearningSimples-FeatureExtractionRegularizer-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02d-transferlearning-featureextraction-hyperparamtuner-chestxray" title="02d-TransferLearning-FeatureExtraction-HyperParamTuner-chestXRay" class="md-nav__link">
    02d-TransferLearning-FeatureExtraction-HyperParamTuner-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02e-auxiliar-imageaugmentation" title="02e-auxiliar-ImageAugmentation" class="md-nav__link">
    02e-auxiliar-ImageAugmentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02e-finetunning-chestxray" title="02e-FineTunning-chestXRay" class="md-nav__link">
    02e-FineTunning-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03-busca-transferlearning-imagenet-chestxray" title="03-Busca-TransferLearning-Imagenet-chestXRay" class="md-nav__link">
    03-Busca-TransferLearning-Imagenet-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#observacoes-finais" title="Observações finais" class="md-nav__link">
    Observações finais
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../notebooks_vazios/" title="Relatório Vazios" class="md-nav__link">
      Relatório Vazios
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../conclusao/" title="Conclusões" class="md-nav__link">
      Conclusões
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sobre/" title="Sobre" class="md-nav__link">
      Sobre
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#01-baseline-redesimples-chestxray" title="01-Baseline-redesimples-chestXRay" class="md-nav__link">
    01-Baseline-redesimples-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01b-baseline-redesimples-chestxray-tamanhomaior" title="01b-Baseline-redesimples-chestXRay-tamanhomaior" class="md-nav__link">
    01b-Baseline-redesimples-chestXRay-tamanhomaior
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02c-transferlearningsimples-featureextractionregularizer-chestxray" title="02c-TransferLearningSimples-FeatureExtractionRegularizer-chestXRay" class="md-nav__link">
    02c-TransferLearningSimples-FeatureExtractionRegularizer-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02d-transferlearning-featureextraction-hyperparamtuner-chestxray" title="02d-TransferLearning-FeatureExtraction-HyperParamTuner-chestXRay" class="md-nav__link">
    02d-TransferLearning-FeatureExtraction-HyperParamTuner-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02e-auxiliar-imageaugmentation" title="02e-auxiliar-ImageAugmentation" class="md-nav__link">
    02e-auxiliar-ImageAugmentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02e-finetunning-chestxray" title="02e-FineTunning-chestXRay" class="md-nav__link">
    02e-FineTunning-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03-busca-transferlearning-imagenet-chestxray" title="03-Busca-TransferLearning-Imagenet-chestXRay" class="md-nav__link">
    03-Busca-TransferLearning-Imagenet-chestXRay
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#observacoes-finais" title="Observações finais" class="md-nav__link">
    Observações finais
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="relatorios-da-base-chestxray">Relatórios da BASE ChestXRay</h1>
<h2 id="01-baseline-redesimples-chestxray">01-Baseline-redesimples-chestXRay</h2>
<p><a href="../html/01-Baseline-redesimples-chestXRay.html" 
target="_blank">01-Baseline-redesimples-chestXRay</a></p>
<p>Rede convolucional bem simples treinada do zero.</p>
<p>Input shape = 150, 150</p>
<p>acc: 0.9279 - val_acc: 0.8285</p>
<h2 id="01b-baseline-redesimples-chestxray-tamanhomaior">01b-Baseline-redesimples-chestXRay-tamanhomaior</h2>
<p><a href="../html/01b-Baseline-redesimples-chestXRay-tamanhomaior.html" 
target="_blank">01b-Baseline-redesimples-chestXRay-tamanhomaior</a></p>
<p>Rede convolucional bem simples treinada do zero.
Treinamento em 04/09/2019:</p>
<p>Foram realizadas várias rodadas(sempre continuando pesos do menor val_loss anterior):</p>
<ul>
<li>
<p>A primeira com ImageAugmentation e lr=0.001, melhor acc=0.94 e melhor val_acc=0.82
Mesmo a rede sendo simples, aparenta ligeiro overfitting</p>
</li>
<li>
<p>A segunda com lr=0.0001 e mais épocas para os callbacks,
 melhor acc=0.94 e melhor val_acc=0.83</p>
</li>
<li>
<p>A terceira sem ImageAugmentation, com lr muito pequena.
 Embora ImageAugmentation seja uma técnica para reduzir overfitting,
 e a priori tirar possa parecer contrasenso, apenas para<br />
 testar se deixar a base de treinamento mais parecida com a de testes reduz erro de
 generalização, ao menos nesses exemplos e no "fine tunning"</p>
</li>
</ul>
<p>Conforme previsto pela teoria, o sobreajuste aumentou. </p>
<p>acc foi para 0.96 e val_acc caiu para menos de 0.80</p>
<ul>
<li>Quarta tentativa, com regularização L1 e L2 na última camada e otimizador Adam,
pareceu que ia conseguir melhoria, foi expandido o treinamento para 50 épocas iniciando com uma
lr maior, mas a melhoria foi apenas marginal, com val_acc ensaiando ultrapassar 0.87 mas oscilando bastante</li>
</ul>
<p>Em 04/06/2019 o melhor modelo foi:</p>
<p>Epoch 14/50
acc: 0.9507 val_acc: 0.8429</p>
<p>Conclusões/próximos passos</p>
<ul>
<li>
<p>Tentar aumentar regularização, utilizar keras-tuner</p>
</li>
<li>
<p>Testar modelo pré-treinado mais poderoso (TransferLearning)</p>
</li>
<li>
<p>Olhar exemplos de kernel no kaggle com melhor desempenho em busca de idéias</p>
</li>
</ul>
<h2 id="02c-transferlearningsimples-featureextractionregularizer-chestxray">02c-TransferLearningSimples-FeatureExtractionRegularizer-chestXRay</h2>
<p><a href="../html/02c-TransferLearningSimplesFeatureExtractionRegularizer-chestXRay.html" 
target="_blank">02c-TransferLearningSimplesFeatureExtractionRegularizer-chestXRay</a></p>
<p>Utilizar DenseNet121 como feature extraction. Treinar classificador na saída desta rede.</p>
<p>Resultado testes:
acc: 0.93 val_acc: 0.82</p>
<p>Próximo passo:</p>
<p>Gravar em .npy uma matriz com todas as features extraídas da base de treinamento e fazer 
Grid Search e Random Search do melhor classificador obtido.</p>
<h2 id="02d-transferlearning-featureextraction-hyperparamtuner-chestxray">02d-TransferLearning-FeatureExtraction-HyperParamTuner-chestXRay</h2>
<p><a href="../html/02d-TransferLearningFeatureExtractionHyperParamTuner-chestXRay.html" 
target="_blank">02d-TransferLearningFeatureExtractionHyperParamTuner-chestXRay</a></p>
<p>Esta rede usa como entrada uma última camada maxpooling já salva, de saída da DenseNet121 aplicada à
base de treinamento. Como todo o processamento convolucional já está realizado, o treinamento do classificador
é centenas de vezes mais rápido. Assim, facilita o tunning da camada classificadora.</p>
<p>Resultado: </p>
<p>Foi possível obter um classificador utilizando somente a saída da DenseNet121 original com pesos da imagenet:</p>
<p>Base original:      acc 0.95 val_acc 0.89
recall pneumonia:       0.95         0.97</p>
<h2 id="02e-auxiliar-imageaugmentation">02e-auxiliar-ImageAugmentation</h2>
<p><a href="../html/02e-auxiliar-ImageAugmentation-chestXRay.html" 
target="_blank">02e-auxiliar-ImageAugmentation</a></p>
<p>Este notebook é apenas para gerar uma base aumentada pré-processada. Será utilizado pelo outro notebook 02e.</p>
<p>O objetivo é tentar diminuir o sobreajuste / distãncia entre acc e val_acc e agilizar a fase de treinamento.</p>
<h2 id="02e-finetunning-chestxray">02e-FineTunning-chestXRay</h2>
<p><a href="../html/02e-FineTunning-chestXRay.html" 
target="_blank">02e-FineTunning-chestXRay</a></p>
<p>Aqui está sendo treinada uma rede DenseNet121 do 02c empilhada com o classificador do 02d. </p>
<p>Problemas: não ficou claro se os pesos do notebook 02d foram aproveitados. Eles são carregados, os testes dão resultado
similar ao 02d, mas quando inicia o treinamento de fine tunning os números de acc e val_acc caem próximos de 0.5,
para depois voltarem a subir, mesmo quando se utiliza uma lr extremamente baixa. </p>
<p>Melhor modelo: 
Transfermodelweights02e_etapa2.02-0.66.hdf5</p>
<p>Base aumentada: acc 0.99 val_acc 0.83</p>
<p>Obs: Houve um problema, o acc na base train indica 99% no treinamento, mas estranhamente cai
para 95% no relatório. Investigar. </p>
<p>Base original:      acc 0.95 val_acc 0.89
recall pneumonia:       0.96         0.97</p>
<h2 id="03-busca-transferlearning-imagenet-chestxray">03-Busca-TransferLearning-Imagenet-chestXRay</h2>
<p><a href="../html/03-Busca-TransferLearning-Imagenet-chestXRay.html" 
target="_blank">03-Busca-TransferLearning-Imagenet-chestXRay</a></p>
<p>Teste do uso das features extraídas de uma rede pré-treinada como hash para busca de similaridade.</p>
<p>Testar através de distância euclidiana se a última camada de rede neural DenseNet121 possui informação interessante
para possibilitar busca por similaridade.</p>
<p>Foram rodadas 1.000 simulações aleatórias de busca para vários batchs diferentes, de 512 itens para base train e 
256 itens para base. No final foram rodadas 1.000 simulações para 10 batches da base treinamento.</p>
<p>A avaliação foi realizada por coincidência de classe nos primeiros 10 e 20 itens e também foi realizada
avaliação visual interativa.</p>
<p>A avaliação visual é muito difícil, precisaria de um especialista médico para avaliar.</p>
<p>A avaliação por classe deu uma coincidência média de menos de 80%, considerada insuficiente. 
Também foi extraída a estatística por classe: </p>
<p>0 = NORMAL 1 = PNEUMONIA</p>
<p><strong>Resultados utilizando MaxPooling</strong></p>
<ul>
<li>Acerto classe 0: 53959 de 72780 (0.74)</li>
<li>Acerto classe 1: 103373 de 127220 (0.81)</li>
</ul>
<p><strong>Resultados utilizando AvgPooling</strong></p>
<ul>
<li>Acerto classe 0: 55893 de 75900 (0.74)</li>
<li>Acerto classe 1: 103782 de 124100 (0.84)</li>
</ul>
<p>Assim, as <em>features</em> extraídas da rede treinada na ImageNet se mostraram insuficientes para busca.
Não obstante, podem ser um ponto de partida, para treinamento de autoencoders ou outras funções
 para gerar um hash para busca de similaridade.  </p>
<h2 id="observacoes-finais">Observações finais</h2>
<p>Considerando que para este tipo de problema o mais importante é um recall alto para pneumonia.</p>
<p>O modelo final tem um recall excelente, embora o desejável neste caso seja 100%, não sabemos se há
erro de rotulagem nem qual o erro humano, muito menos o Bayes Error. Portanto, não dá para saber se 
é factível melhorar acima de 95-97% de recall. </p>
<p>Não foi possível obter ganhos significativos em relação ao baseline com as técnicas empregadas. 
A melhoria foi marginal, de menos de 5% em relação à rede neural simples. Tabela abaixo.</p>
<p>REDE 01b
Accuracy:           acc 0.95 val_acc 0.85
recall pneumonia:       0.94         0.95
REDE 02e
Accuracy:           acc 0.95 val_acc 0.89
recall pneumonia:       0.96         0.97</p>
<p>A diferença entre treinamento e validação demonstra uma variância grande, mas pelos testes na base seria importante checar
se não se trata de um  <em>data mismatch</em>. Esta base parece ter problemas de balanceamento e também de distribuição. Como
próximo passo, seria interessante fundir todos os exemplos da base orginal (train, val, test) em uma base única e fazer um
<em>resample</em> das bases de treinamento e validação, rodando cópias destes notebooks e comparando os resultados. Além disso,
testar técnicas adicionais de <em>image augmentation</em> e balanceamento de classes (parâmetro <em>class weight</em> ou aumento de uma
categoria).</p>
<h2 id="_1"></h2>
<p><a href="../html/.html" 
target="_blank"></a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../resumo/" title="Análise" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Análise
              </span>
            </div>
          </a>
        
        
          <a href="../notebooks_vazios/" title="Relatório Vazios" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Relatório Vazios
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>